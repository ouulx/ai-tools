<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiaCantik - AI Produktivitas</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Mengatur font default ke Inter */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar untuk jendela chat */
        .chat-window::-webkit-scrollbar {
            width: 6px;
        }
        .chat-window::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
            border-radius: 10px;
        }
        .chat-window::-webkit-scrollbar-thumb {
            background: #94a3b8; /* gray-400 */
            border-radius: 10px;
        }
        .chat-window::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* gray-500 */
        }

        /* Animasi spinner untuk loading */
        .loader {
            border: 4px solid #f3f3f3; /* gray-100 */
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex flex-col h-screen max-w-3xl mx-auto bg-white shadow-2xl rounded-lg overflow-hidden my-0 sm:my-4">
        
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 p-4 shadow-sm">
            <h1 class="text-2xl font-bold text-center text-blue-600">LiaCantik</h1>
            <p class="text-sm text-gray-500 text-center">Asisten Produktivitas AI Anda</p>
        </header>

        <!-- Jendela Chat -->
        <main id="chat-window" class="flex-grow p-6 overflow-y-auto space-y-4 bg-gray-50 chat-window">
            <!-- Pesan chat akan muncul di sini -->
        </main>

        <!-- Indikator Loading (tersembunyi) -->
        <div id="loading-indicator" class="hidden p-4 self-start">
            <div class="flex items-center space-x-2">
                <div class="loader"></div>
                <span class="text-sm text-gray-500">Lia sedang mengetik...</span>
            </div>
        </div>

        <!-- Input Form -->
        <footer class="bg-white border-t border-gray-200 p-4">
            <form id="message-form" class="flex items-center space-x-3">
                <input 
                    type="text" 
                    id="message-input"
                    placeholder="Ketik pesan Anda di sini..."
                    class="flex-grow border border-gray-300 rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                    autocomplete="off"
                >
                <button 
                    type="submit" 
                    id="send-button"
                    class="bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50"
                >
                    <!-- Ikon Send (Paper Airplane) -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 transform rotate-45">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L5.999 12zm0 0h7.5" />
                    </svg>
                </button>
            </form>
        </footer>
    </div>

    <!-- Modal Error (tersembunyi) -->
    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-lg font-medium text-red-600">Oops! Terjadi Kesalahan</h3>
            <p id="error-message" class="text-sm text-gray-600 mt-2 mb-4">
                Maaf, terjadi masalah saat menghubungi AI.
            </p>
            <button id="close-error-modal" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200">
                Tutup
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referensi Elemen DOM
            const chatWindow = document.getElementById('chat-window');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            // Modal Error
            const errorModal = document.getElementById('error-modal');
            const errorMessage = document.getElementById('error-message');
            const closeErrorModal = document.getElementById('close-error-modal');

            // --- State Aplikasi ---
            // Menyimpan riwayat percakapan untuk dikirim ke API
            let chatHistory = [];
            // API Key (Biarkan kosong, akan ditangani oleh environment)
            const apiKey = ""; 
            // API Endpoint Gemini
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // System Prompt untuk AI Produktivitas
            const SYSTEM_PROMPT = `Anda adalah "LiaCantik" (atau Lia), seorang asisten AI yang sangat profesional, ramah, dan sangat fokus pada produktivitas. Misi utama Anda adalah membantu pengguna menyelesaikan pekerjaan mereka dengan lebih efisien.
            
            Aturan Peran:
            1.  **Nama:** Selalu perkenalkan diri Anda atau gunakan nama "Lia" jika sesuai.
            2.  **Tujuan:** Fokus pada tugas-tugas produktif: menyusun draf email, membuat rencana, brainstorming ide, meringkas teks, mengoreksi tata bahasa, dan menjawab pertanyaan terkait pekerjaan.
            3.  **Nada Suara:** Sopan, suportif, jelas, dan lugas. Gunakan bahasa Indonesia yang baik dan modern.
            4.  **Tindakan:** Selalu berikan jawaban yang dapat ditindaklanjuti. Jika pengguna meminta draf email, berikan draf lengkap. Jika mereka meminta ide, berikan dalam bentuk daftar poin.
            5.  **Penolakan:** Jika pengguna meminta sesuatu yang jauh di luar topik produktivitas (misalnya, gosip, atau konten tidak pantas), tolak dengan sopan dan kembalikan percakapan ke topik produktivitas. Contoh: "Maaf, saya adalah asisten yang fokus pada produktivitas. Mungkin kita bisa kembali menyusun presentasi Anda?"`;

            // --- Fungsi ---

            /**
             * Menampilkan pesan di jendela chat
             * @param {string} message - Teks pesan
             * @param {'user' | 'model'} role - Pengirim pesan
             */
            function addMessageToUI(message, role) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-3 rounded-xl max-w-lg shadow-sm ${
                    role === 'user' 
                        ? 'bg-blue-600 text-white self-end' 
                        : 'bg-white text-gray-800 self-start border border-gray-200'
                }`;
                
                // Parser Markdown sederhana untuk teks dari model
                if (role === 'model') {
                    messageDiv.innerHTML = simpleMarkdownParse(message);
                } else {
                    messageDiv.textContent = message;
                }
                
                chatWindow.appendChild(messageDiv);
                // Scroll otomatis ke bawah
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            /**
             * Mengubah teks Markdown sederhana menjadi HTML
             * @param {string} text - Teks mentah dari AI
             * @returns {string} - Teks yang sudah diformat HTML
             */
            function simpleMarkdownParse(text) {
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italic
                    .replace(/\n/g, '<br>');                      // Newlines
            }

            /**
             * Menampilkan atau menyembunyikan indikator loading
             * @param {boolean} isLoading - Status loading
             */
            function toggleLoading(isLoading) {
                if (isLoading) {
                    loadingIndicator.classList.remove('hidden');
                    sendButton.disabled = true;
                    messageInput.disabled = true;
                } else {
                    loadingIndicator.classList.add('hidden');
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            }

            /**
             * Menampilkan modal error
             * @param {string} message - Pesan error
             */
            function showError(message) {
                errorMessage.textContent = message || 'Maaf, terjadi masalah koneksi. Silakan coba lagi.';
                errorModal.classList.remove('hidden');
            }

            /**
             * Menangani pengiriman form
             * @param {Event} e - Event submit
             */
            async function handleSend(e) {
                e.preventDefault();
                const userInput = messageInput.value.trim();

                if (!userInput) return;

                // 1. Tampilkan pesan pengguna di UI
                addMessageToUI(userInput, 'user');
                
                // 2. Tambahkan pesan pengguna ke riwayat chat
                chatHistory.push({ role: "user", parts: [{ text: userInput }] });

                // 3. Bersihkan input
                messageInput.value = '';

                // 4. Tampilkan loading
                toggleLoading(true);

                // 5. Panggil API
                await callGeminiAPIWithBackoff();
            }

            /**
             * Memanggil Gemini API dengan strategi exponential backoff
             * @param {number} retries - Jumlah percobaan ulang
             * @param {number} delay - Waktu tunda awal (ms)
             */
            async function callGeminiAPIWithBackoff(retries = 3, delay = 1000) {
                const payload = {
                    contents: chatHistory,
                    systemInstruction: {
                        parts: [{ text: SYSTEM_PROMPT }]
                    }
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0) {
                        const modelText = result.candidates[0].content.parts[0].text;

                        // 6. Tambahkan respons AI ke riwayat
                        chatHistory.push({ role: "model", parts: [{ text: modelText }] });

                        // 7. Tampilkan respons AI di UI
                        addMessageToUI(modelText, 'model');
                    } else {
                        throw new Error('Respons AI tidak valid.');
                    }

                } catch (error) {
                    console.error('Error calling Gemini API:', error.message);
                    
                    if (retries > 0) {
                        // Coba lagi dengan delay
                        await new Promise(res => setTimeout(res, delay));
                        await callGeminiAPIWithBackoff(retries - 1, delay * 2); // Double delay
                    } else {
                        // Gagal setelah semua percobaan
                        showError(`Gagal terhubung dengan Lia setelah beberapa kali percobaan. Silakan cek koneksi Anda. Error: ${error.message}`);
                    }
                } finally {
                    // Hentikan loading hanya jika semua percobaan gagal
                    if (retries === 0) {
                        toggleLoading(false);
                    }
                }
            }

            // --- Event Listeners ---
            messageForm.addEventListener('submit', handleSend);
            closeErrorModal.addEventListener('click', () => {
                errorModal.classList.add('hidden');
            });

            // --- Inisialisasi ---
            // Tampilkan pesan selamat datang dari bot
            addMessageToUI("Halo! Saya Lia, asisten produktivitas Anda. Ada yang bisa saya bantu untuk menyusun email, brainstorming ide, atau tugas lainnya hari ini?", 'model');
            messageInput.focus();
        });
    </script>

</body>
</html>